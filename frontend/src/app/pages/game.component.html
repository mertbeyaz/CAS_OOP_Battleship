<ng-container *ngIf="loading; else loaded">
  <div class="loader">Lade Spiel...</div>
</ng-container>

<ng-template #loaded>
  <p *ngIf="error" class="error">{{ error }}</p>
  <p *ngIf="!game && !error" class="info">Kein Spiel geladen.</p>

  <main class="game" *ngIf="game">
    <div class="bg"></div>
    <div class="shell">
      <header class="topbar">
        <div>
          <p class="label">Game Code</p>
          <p class="value">{{ game.gameCode }}</p>
        </div>
        <div>
          <p class="label">Status</p>
          <p class="value">{{ game.status }}</p>
        </div>
        <div *ngIf="game.status === 'RUNNING'" class="pill success">
          Am Zug: {{ game.yourTurn ? myPlayerName : (game.opponentName || 'Gegner') }}
        </div>
        <div *ngIf="game.status === 'FINISHED'" class="pill warn">
          Spiel beendet
        </div>
      </header>

      <section class="panel players">
        <table class="players-table">
          <thead>
          <tr>
            <th>Spieler</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>{{ myPlayerName }} <span class="tag">(du)</span></td>
            <td>{{ game.yourBoardLocked ? 'Ready' : 'Wartet...' }}</td>
            <td>
              <button (click)="markReady()" [disabled]="!isSetup() || readyLoading || readyDone">
                {{ readyDone ? 'Ready' : 'Ready werden' }}
              </button>
              <button (click)="autoPlacement()" [disabled]="!isSetup() || readyDone || autoLoading">
                Autoplacement
              </button>
              <button class="forfeit" (click)="forfeitGame()" [disabled]="forfeitLoading || game.status === 'FINISHED'">
                Aufgeben
              </button>
            </td>
          </tr>
          <tr>
            <td>{{ game.opponentName || 'Gegner' }}</td>
            <td>{{ game.opponentBoardLocked ? 'Ready' : 'Wartet...' }}</td>
            <td></td>
          </tr>
          </tbody>
        </table>
      </section>

      <section class="boards-grid">
        <div class="panel board" *ngIf="myBoardState; else noBoard">
          <div class="panel-head">
            <h3>Dein Board</h3>
          </div>
          <div class="grid" [style.--w]="myBoardState.width" [style.--h]="myBoardState.height">
            <span
              class="cell"
              *ngFor="let _ of cells(myBoardState.width * myBoardState.height); let i = index"
              [ngClass]="cellStateForMine(i % myBoardState.width, Math.floor(i / myBoardState.width))"
            >
              {{ cellLabel(i, myBoardState.width) }}
            </span>
          </div>
        </div>

        <ng-template #noBoard>
          <div class="panel board">
            <div class="panel-head">
              <h3>Dein Board</h3>
            </div>
            <p class="info">Board noch nicht geladen. Nutze Autoplacement.</p>
          </div>
        </ng-template>

        <div class="panel board">
          <div class="panel-head">
            <h3>Gegner-Board</h3>
          </div>
          <p class="info">Gegner-Board kann ohne Public API nicht geladen werden.</p>
        </div>

        <section class="panel chat">
          <div class="panel-head"><h3>Chat</h3></div>
          <div class="messages" #messagesContainer>
            <div class="message" *ngFor="let m of chatMessages" [class.me]="m.senderId === myPlayerId">
              <span class="name">
                {{ m.senderName || (m.senderId === myPlayerId ? myPlayerName : (game.opponentName || 'Gegner')) }}
              </span>
              <span class="text">{{ m.message }}</span>
            </div>
          </div>
          <form (ngSubmit)="sendChat()" class="chat-form">
            <input [(ngModel)]="chatInput" name="chatInput" autocomplete="off" placeholder="Nachricht..." />
            <button type="submit" [disabled]="!chatInput.trim()">Senden</button>
          </form>
        </section>
      </section>
    </div>
  </main>
</ng-template>
