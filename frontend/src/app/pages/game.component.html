<ng-container *ngIf="loading; else loaded">
  <!-- Loading state -->
  <div class="loader">Lade Spiel...</div>
</ng-container>

<ng-template #loaded>
  <!-- Error / empty states -->
  <p *ngIf="error" class="error">{{ error }}</p>
  <p *ngIf="!game && !error" class="info">Kein Spiel geladen.</p>

  <!-- Main game UI -->
  <main class="game" *ngIf="game">
    <!-- Background layer -->
    <div class="bg"></div>
    <div class="shell">
      <!-- Status header -->
      <header class="topbar">
        <div>
          <p class="label">Resume Token</p>
          <p class="value">{{ resumeToken }}</p>
        </div>

        <div>
          <p class="label">Game Code</p>
          <p class="value">{{ game.gameCode }}</p>
        </div>
        <div *ngIf="game.status === 'WAITING' && waitingForResume" class="pill warn">
          Resume gedrÇÎ¶ªckt ’'?" warte auf Gegner...
        </div>
        <div>
          <p class="label">Status</p>
          <p class="value">{{ game.status }}</p>
        </div>
        <div *ngIf="game.status === 'RUNNING'" class="pill success">
          Am Zug: {{ game.yourTurn ? myPlayerName : (game.opponentName || 'Gegner') }}
        </div>
        <div *ngIf="forfeitedByName" class="pill warn">
          Aufgegeben: {{ forfeitedByName }}
        </div>
        <div *ngIf="game.status === 'FINISHED'" class="pill warn">
          Spiel beendet
        </div>
      </header>

      <!-- Players table -->
      <section class="panel players">
        <table class="players-table">
          <thead>
          <tr>
            <th>Spieler</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>
              {{ myPlayerName }} <span class="tag">(du)</span>
            </td>
            <td>{{ game.yourBoardLocked ? 'Ready' : 'Wartet...' }}</td>
            <td>
              <button (click)="markReady()" [disabled]="!isSetup() || readyLoading || readyDone">
                {{ readyDone ? 'Ready' : 'Ready werden' }}
              </button>
              <button (click)="autoPlacement()" [disabled]="!isSetup() || readyDone || autoLoading">
                Autoplacement
              </button>
              <button (click)="pauseGame()" [disabled]="game.status !== 'RUNNING' || pauseLoading">
                Pause
              </button>
              <button (click)="resumeGame()" [disabled]="game.status !== 'PAUSED' && game.status !== 'WAITING'">
                Resume
              </button>
              <button class="forfeit" (click)="forfeitGame()" [disabled]="forfeitLoading || game.status === 'FINISHED'">
                Aufgeben
              </button>
            </td>
          </tr>
          <tr>
            <td>{{ game.opponentName || 'Gegner' }}</td>
            <td>{{ game.opponentBoardLocked ? 'Ready' : 'Wartet...' }}</td>
            <td></td>
          </tr>
          </tbody>
        </table>
      </section>

      <!-- Boards + chat layout -->
      <section class="boards-grid">
        <!-- Your board -->
        <div class="panel board">
          <div class="panel-head">
            <h3>Dein Board</h3>
          </div>
          <div class="grid" [style.--w]="boardWidth" [style.--h]="boardHeight">
            <span
              class="cell"
              *ngFor="let _ of cells(boardWidth * boardHeight); let i = index"
              [ngClass]="cellStateForMine(i % boardWidth, Math.floor(i / boardWidth))"
            >
              {{ cellLabel(i, boardWidth) }}
            </span>
          </div>
        </div>

        <!-- Opponent board -->
        <div class="panel board">
          <div class="panel-head">
            <h3>Gegner-Board</h3>
          </div>
          <div class="grid" [style.--w]="boardWidth" [style.--h]="boardHeight">
            <span
              class="cell"
              *ngFor="let _ of cells(boardWidth * boardHeight); let i = index"
              [ngClass]="cellStateForOpp(i % boardWidth, Math.floor(i / boardWidth))"
              [class.clickable]="canShoot()"
              [class.disabled]="!canShoot()"
              (click)="canShoot() && fireShot(i % boardWidth, Math.floor(i / boardWidth))"
            >
              {{ cellLabel(i, boardWidth) }}
            </span>
          </div>

          <!-- Cell legend -->
          <div class="legend">
            <span class="legend-item"><span class="legend-swatch miss"></span>Miss</span>
            <span class="legend-item"><span class="legend-swatch hit"></span>Hit</span>
            <span class="legend-item"><span class="legend-swatch sunk"></span>Sunk</span>
          </div>

          <p *ngIf="shotError" class="error">{{ shotError }}</p>
        </div>

        <!-- Chat -->
        <section class="panel chat">
          <div class="panel-head"><h3>Chat</h3></div>
          <div class="messages" #messagesContainer>
            <div class="message" *ngFor="let m of chatMessages" [class.me]="m.senderId === myPlayerId">
              <span class="name">
                {{ m.senderName || (m.senderId === myPlayerId ? myPlayerName : (game.opponentName || 'Gegner')) }}
              </span>
              <span class="text">{{ m.message }}</span>
            </div>
          </div>

          <div class="chat-footer">
            <form (ngSubmit)="sendChat()" class="chat-form">
              <input [(ngModel)]="chatInput" name="chatInput" autocomplete="off" placeholder="Nachricht..." />
              <button type="submit" [disabled]="!chatInput.trim()">Senden</button>
            </form>
          </div>
        </section>
      </section>
    </div>
  </main>
</ng-template>
