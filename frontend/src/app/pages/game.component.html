<ng-container *ngIf="loading; else loaded">
  <div class="loader">Lade Spiel...</div>
</ng-container>

<ng-template #loaded>
  <p *ngIf="error" class="error">{{ error }}</p>
  <p *ngIf="!game && !error" class="info">Kein Spiel geladen.</p>

  <main class="game" *ngIf="game">
    <div class="bg"></div>
    <div class="shell">
      <header class="topbar">
        <div>
          <p class="label">Game Code</p>
          <p class="value">{{ game.gameCode }}</p>
        </div>
        <div>
          <p class="label">Status</p>
          <p class="value">{{ game.status }}</p>
        </div>
        <div *ngIf="game.status === 'RUNNING' && game.currentTurnPlayerId" class="pill success">
          Am Zug: {{ playerName(game.currentTurnPlayerId) }}
        </div>
        <div *ngIf="game.status === 'FINISHED' && game.winnerPlayerId" class="pill warn">
          Gewinner: {{ playerName(game.winnerPlayerId) }}
        </div>
      </header>

      <section class="panel players">
        <table class="players-table">
          <thead>
          <tr>
            <th>Spieler</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let p of game.players">
            <td>
              {{ p.username }}
              <span *ngIf="p.id === myPlayerId" class="tag">(du)</span>
            </td>
            <td>{{ readyPlayers.has(p.id) ? 'Ready' : 'Wartet...' }}</td>
            <td>
              <ng-container *ngIf="p.id === myPlayerId">
                <button (click)="markReady()" [disabled]="!isSetup() || readyLoading || readyDone">
                  {{ readyDone ? 'Ready' : 'Ready werden' }}
                </button>
                <button (click)="autoPlacement()" [disabled]="!isSetup() || readyDone || autoLoading">
                  Autoplacement
                </button>
                <button class="forfeit" (click)="forfeitGame()" [disabled]="forfeitLoading || game?.status === 'FINISHED'">
                  Aufgeben
                </button>
              </ng-container>
            </td>
          </tr>
          </tbody>
        </table>
      </section>

      <section class="boards-grid">
        <div class="panel board" *ngIf="myBoard">
          <div class="panel-head">
            <h3>Dein Board</h3>
          </div>
          <div class="grid" [style.--w]="myBoard.width" [style.--h]="myBoard.height">
            <span
              class="cell"
              *ngFor="let _ of cells(myBoard.width * myBoard.height); let i = index"
              [ngClass]="cellStateForMine(i % myBoard.width, Math.floor(i / myBoard.width))"
            >
              {{ cellLabel(i, myBoard.width) }}
            </span>
          </div>
        </div>

        <div class="panel board" *ngIf="opponentBoard">
          <div class="panel-head">
            <h3>Gegner-Board</h3>
          </div>
          <div class="grid" [style.--w]="opponentBoard.width" [style.--h]="opponentBoard.height">
            <span
              class="cell"
              *ngFor="let _ of cells(opponentBoard.width * opponentBoard.height); let i = index"
              [ngClass]="cellStateForOpp(i % opponentBoard.width, Math.floor(i / opponentBoard.width))"
              [class.clickable]="canShoot()"
              [class.disabled]="!canShoot()"
              (click)="canShoot() && fireShot(i % opponentBoard.width, Math.floor(i / opponentBoard.width))"
            >
              {{ cellLabel(i, opponentBoard.width) }}
            </span>
          </div>
          <p *ngIf="shotError" class="error">{{ shotError }}</p>
        </div>

        <section class="panel chat">
          <div class="panel-head"><h3>Chat</h3></div>
          <div class="messages" #messagesContainer>
            <div class="message" *ngFor="let m of chatMessages" [class.me]="m.senderId === myPlayerId">
              <span class="name">{{ m.senderName || playerName(m.senderId) || m.senderId }}</span>
              <span class="text">{{ m.message }}</span>
            </div>
          </div>
          <form (ngSubmit)="sendChat()" class="chat-form">
            <input [(ngModel)]="chatInput" name="chatInput" autocomplete="off" placeholder="Nachricht..." />
            <button type="submit" [disabled]="!chatInput.trim()">Senden</button>
          </form>
        </section>
      </section>
    </div>
  </main>
</ng-template>
