<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Battleship Chat – 2 User Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #020617;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
        }

        .root {
            width: 100%;
            max-width: 1100px;
        }

        h1 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: #facc15;
        }

        .subtitle {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .game-settings {
            display: flex;
            gap: 1.75rem;
            align-items: flex-end;
            margin-bottom: 1rem;
        }

        .field {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        label {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 0.2rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.85rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
        }

        button {
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            background: #22c55e;
            color: #020617;
            font-weight: 600;
        }

        button.secondary {
            background: #4b5563;
            color: #e5e7eb;
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .chat-panel {
            background: #020617;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #1f2937;
            box-shadow: 0 18px 35px rgba(0,0,0,0.4);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .panel-subtitle {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .status {
            font-size: 0.75rem;
            text-align: right;
        }

        .status span {
            font-weight: 600;
        }

        .status .connected {
            color: #22c55e;
        }

        .status .disconnected {
            color: #f97316;
        }

        .player-info {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 0.6rem;
        }

        .player-info span {
            color: #e5e7eb;
        }

        .messages {
            border-radius: 10px;
            border: 1px solid #111827;
            background: #020617;
            height: 220px;
            padding: 0.5rem;
            overflow-y: auto;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
        }

        .msg {
            margin-bottom: 0.35rem;
        }

        .msg-meta {
            color: #6b7280;
            font-size: 0.7rem;
        }

        .msg-text {
            color: #e5e7eb;
        }

        .msg-self .msg-text {
            color: #a5b4fc;
        }

        .input-row {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .input-row input[type="text"] {
            flex: 1;
        }

        .footer-hint {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 0.25rem;
            text-align: right;
        }

        .hint {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 2px;
            position: absolute;
        }
    </style>
</head>
<body>
<div class="root">
    <h1>Battleship Chat – 2 User Test</h1>
    <div class="subtitle">
        Game Code eingeben → Spieler werden via REST geladen → beide Chat-Clients verbinden → Chat & Persistenz testen.
    </div>

    <div class="game-settings">
        <div class="field">
            <label for="gameCode">Game Code</label>
            <input type="text" id="gameCode" placeholder="TEST-CODE">
            <!--<div class="hint">Muss zu einem Game passen, das genau 1–2 Spieler hat.</div>-->
        </div>
        <div>
            <button onclick="loadPlayersAndConnect()">Connect</button>
        </div>
    </div>

    <div class="two-columns">
        <!-- Panel A -->
        <div class="chat-panel" id="panelA">
            <div class="panel-header">
                <div>
                    <div class="panel-title">User A</div>
                    <div class="panel-subtitle">linkes Chat-Fenster</div>
                </div>
                <div class="status">
                    Status: <span id="statusA" class="disconnected">disconnected</span><br>
                    <span id="playerLabelA">Player A: &lt;unbekannt&gt;</span>
                </div>
            </div>

            <div class="messages" id="messagesA"></div>

            <div class="input-row">
                <input type="text" id="messageA"
                       placeholder="Nachricht von User A..."
                       onkeydown="if (event.key === 'Enter') sendMessage('A');">
                <button id="sendBtnA" onclick="sendMessage('A')" disabled>Send</button>
            </div>
            <div class="footer-hint">Enter ↵ sendet für User A</div>

            <div style="margin-top:0.5rem; display:flex; gap:0.4rem; justify-content:flex-end;">
                <button class="secondary" onclick="disconnectClient('A')">Disconnect A</button>
            </div>
        </div>

        <!-- Panel B -->
        <div class="chat-panel" id="panelB">
            <div class="panel-header">
                <div>
                    <div class="panel-title">User B</div>
                    <div class="panel-subtitle">rechtes Chat-Fenster</div>
                </div>
                <div class="status">
                    Status: <span id="statusB" class="disconnected">disconnected</span><br>
                    <span id="playerLabelB">Player B: &lt;unbekannt&gt;</span>
                </div>
            </div>

            <div class="messages" id="messagesB"></div>

            <div class="input-row">
                <input type="text" id="messageB"
                       placeholder="Nachricht von User B..."
                       onkeydown="if (event.key === 'Enter') sendMessage('B');">
                <button id="sendBtnB" onclick="sendMessage('B')" disabled>Send</button>
            </div>
            <div class="footer-hint">Enter ↵ sendet für User B</div>

            <div style="margin-top:0.5rem; display:flex; gap:0.4rem; justify-content:flex-end;">
                <button class="secondary" onclick="disconnectClient('B')">Disconnect B</button>
            </div>
        </div>
    </div>
</div>

<!-- SockJS + STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    // Client-State inkl. Player-Infos
    const clients = {
        A: { stomp: null, connected: false, playerId: null, username: null },
        B: { stomp: null, connected: false, playerId: null, username: null }
    };

    async function loadPlayersAndConnect() {
        const gameCode = document.getElementById('gameCode').value.trim();
        if (!gameCode) {
            alert('Bitte Game Code eingeben.');
            return;
        }

        try {
            // URL ggf. an dein Game-Endpoint anpassen:
            // z.B. /api/games/{gameCode} oder /api/game/{gameCode}
            const response = await fetch(`/api/games/${encodeURIComponent(gameCode)}`);
            if (!response.ok) {
                alert('Game nicht gefunden oder Fehler beim Laden (' + response.status + ').');
                return;
            }

            const game = await response.json();

            if (!game.players || game.players.length === 0) {
                alert('Keine Spieler im Game gefunden.');
                return;
            }

            // Spieler A und B aus den Daten wählen
            const playerA = game.players[0];
            const playerB = game.players.length > 1 ? game.players[1] : null;

            // UI updaten
            setPlayerForClient('A', playerA);
            if (playerB) {
                setPlayerForClient('B', playerB);
            } else {
                // Kein zweiter Spieler: Panel B „leer“ lassen
                clients.B.playerId = null;
                clients.B.username = null;
                document.getElementById('playerLabelB').textContent = 'Player B: <kein Spieler>';
            }

            // Verbindungen aufbauen
            connectClient('A');
            if (playerB) {
                connectClient('B');
            }

        } catch (e) {
            console.error(e);
            alert('Fehler beim Laden der Spieler: ' + e);
        }
    }

    function setPlayerForClient(clientKey, player) {
        if (!player) return;
        clients[clientKey].playerId = player.id;
        clients[clientKey].username = player.username;

        const labelEl = document.getElementById('playerLabel' + clientKey);
        labelEl.innerHTML = `Player ${clientKey}: <span>${player.username}</span><br><span style="font-size:0.7rem;color:#6b7280;">${player.id}</span>`;
    }

    function setStatus(clientKey, connected) {
        const statusEl = document.getElementById('status' + clientKey);
        const sendBtn = document.getElementById('sendBtn' + clientKey);

        if (connected) {
            statusEl.textContent = 'connected';
            statusEl.classList.remove('disconnected');
            statusEl.classList.add('connected');
            sendBtn.disabled = false;
        } else {
            statusEl.textContent = 'disconnected';
            statusEl.classList.remove('connected');
            statusEl.classList.add('disconnected');
            sendBtn.disabled = true;
        }

        clients[clientKey].connected = connected;
    }

    function connectClient(clientKey) {
        const gameCode = document.getElementById('gameCode').value.trim();
        if (!gameCode) {
            alert('Bitte Game Code eingeben.');
            return;
        }

        const client = clients[clientKey];
        if (!client.playerId) {
            alert('Kein Player für Client ' + clientKey + ' gesetzt.');
            return;
        }

        if (client.stomp && client.connected) {
            client.stomp.disconnect();
            client.stomp = null;
        }

        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        stompClient.debug = null;

        const topic = `/topic/games/${gameCode}/chat`;

        stompClient.connect({}, function(frame) {
            console.log('Client ' + clientKey + ' connected: ' + frame);
            client.stomp = stompClient;
            setStatus(clientKey, true);

            stompClient.subscribe(topic, function(messageFrame) {
                const body = JSON.parse(messageFrame.body);
                appendMessage(clientKey, body);
            });
        }, function(error) {
            console.error('STOMP error for client ' + clientKey, error);
            alert('Verbindung für ' + clientKey + ' fehlgeschlagen: ' + error);
            setStatus(clientKey, false);
        });
    }

    function disconnectClient(clientKey) {
        const client = clients[clientKey];
        if (client.stomp && client.connected) {
            client.stomp.disconnect(() => {
                console.log('Client ' + clientKey + ' disconnected');
                setStatus(clientKey, false);
            });
        } else {
            setStatus(clientKey, false);
        }
    }

    function sendMessage(clientKey) {
        const client = clients[clientKey];
        if (!client.stomp || !client.connected) {
            alert('Client ' + clientKey + ' ist nicht verbunden.');
            return;
        }

        const gameCode = document.getElementById('gameCode').value.trim();
        const textInput = document.getElementById('message' + clientKey);
        const text = textInput.value.trim();

        if (!text) return;

        const destination = `/app/games/${gameCode}/chat`;

        const payload = {
            senderId: client.playerId,
            message: text
        };

        client.stomp.send(destination, {}, JSON.stringify(payload));
        textInput.value = '';
    }

    function appendMessage(clientKey, msg) {
        const messagesDiv = document.getElementById('messages' + clientKey);
        const client = clients[clientKey];

        const wrapper = document.createElement('div');
        wrapper.classList.add('msg');
        if (client.playerId && msg.senderId === client.playerId) {
            wrapper.classList.add('msg-self');
        }

        const meta = document.createElement('div');
        meta.classList.add('msg-meta');

        let timeStr = msg.timestamp || '';
        try {
            if (msg.timestamp) {
                const d = new Date(msg.timestamp);
                timeStr = d.toLocaleTimeString();
            }
        } catch (e) {
            // ignore
        }

        const senderName = msg.senderName || msg.senderId;

        meta.textContent = `[${timeStr}] ${senderName}`;

        const text = document.createElement('div');
        text.classList.add('msg-text');
        text.textContent = msg.message;

        wrapper.appendChild(meta);
        wrapper.appendChild(text);
        messagesDiv.appendChild(wrapper);

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
